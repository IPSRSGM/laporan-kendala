<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard Admin IPSRS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

<style>
body{
  font-family:'Poppins',sans-serif;
  background:linear-gradient(135deg,#1e90ff,#00c6ff);
  margin:0;
  padding:20px;
}
h2{text-align:center;color:black}
.card{
  background:rgba(255,255,255,.25);
  backdrop-filter:blur(12px);
  border-radius:18px;
  padding:15px;
  margin-bottom:15px;
  color:black;
}
select, textarea, input{
  width:100%;
  margin-top:6px;
  padding:10px;
  border-radius:12px;
  border:none;
}
textarea{resize:none}
button{
  margin-top:10px;
  width:100%;
  padding:12px;
  border:none;
  border-radius:14px;
  background:linear-gradient(135deg,#0066ff,#00ccff);
  color:white;
  font-weight:600;
  cursor:pointer;
}
.filter,.statistik{
  background:white;
  border-radius:16px;
  padding:12px;
  margin-bottom:15px;
}
.stat-grid{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:10px;
  text-align:center;
}
.stat-box{
  background:#f1f5f9;
  border-radius:12px;
  padding:10px;
  font-weight:600;
}
#wrapper-print{display:block}
#wrapper-print.print-mode button,
#wrapper-print.print-mode .filter{display:none}

#toast{
  position:fixed;
  top:20px;
  right:20px;
  background:#111;
  color:white;
  padding:12px 20px;
  border-radius:14px;
  display:none;
  z-index:999;
}
.waktu{font-size:12px;color:#333;margin-bottom:6px}

@media print{
  body{background:white}
  button,.filter{display:none}
}
</style>
</head>

<body>

<div id="wrapper-print">

<h2>üìã Dashboard Admin / Teknisi IPSRS</h2>

<!-- STATISTIK -->
<div class="statistik">
  <b>üìä Statistik Bulan Ini</b>
  <div class="stat-grid">
    <div class="stat-box">Total<br><span id="st-total">0</span></div>
    <div class="stat-box">Baru<br><span id="st-baru">0</span></div>
    <div class="stat-box">Proses<br><span id="st-proses">0</span></div>
    <div class="stat-box">Selesai<br><span id="st-selesai">0</span></div>
  </div>
</div>

<!-- FILTER -->
<div class="filter">
  <label>üîç Cari Laporan</label>
  <input type="text" id="searchInput" placeholder="Nama / Unit / Kendala">

  <label>üìÖ Filter Tanggal</label>
  <input type="date" id="dateInput">

  <button onclick="exportExcel()">‚¨á Export Excel</button>
  <button onclick="window.print()">üñ®Ô∏è Cetak Laporan</button>
</div>

<div id="toast"></div>
<div id="daftarLaporan">Memuat data...</div>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
firebase.initializeApp({
  apiKey:"ISI_API_KEY_FIREBASE",
  authDomain:"laporan-kendala-rsgm-165f6.firebaseapp.com",
  projectId:"laporan-kendala-rsgm-165f6"
});
const db=firebase.firestore();

function showToast(msg){
  const t=document.getElementById("toast");
  t.innerText=msg;
  t.style.display="block";
  setTimeout(()=>t.style.display="none",3000);
}

let allData=[];

// batas 1 bulan
const batas=new Date();
batas.setDate(1);

db.collection("laporan")
.where("waktu",">=",batas)
.orderBy("waktu","desc")
.onSnapshot(snapshot=>{
  allData=[];
  snapshot.forEach(doc=>{
    allData.push({id:doc.id,...doc.data()});
  });
  renderData();
  hitungStatistik();
});

function hitungStatistik(){
  let total=0,baru=0,proses=0,selesai=0;
  allData.forEach(d=>{
    total++;
    if(d.status==="baru")baru++;
    if(d.status==="proses")proses++;
    if(d.status==="selesai")selesai++;
  });
  st-total.innerText=total;
  st-baru.innerText=baru;
  st-proses.innerText=proses;
  st-selesai.innerText=selesai;
}

function renderData(){
  const daftar=document.getElementById("daftarLaporan");
  daftar.innerHTML="";

  const search=searchInput.value.toLowerCase();
  const date=dateInput.value;

  const filtered=allData.filter(d=>{
    const textMatch=
      (d.nama||"").toLowerCase().includes(search) ||
      (d.unit||"").toLowerCase().includes(search) ||
      (d.kendala||"").toLowerCase().includes(search);

    let dateMatch=true;
    if(date && d.waktu){
      dateMatch=d.waktu.toDate().toISOString().slice(0,10)===date;
    }
    return textMatch && dateMatch;
  });

  if(filtered.length===0){
    daftar.innerHTML="Tidak ada laporan";
    return;
  }

  filtered.forEach(d=>{
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <div class="waktu">üïí ${d.waktu?d.waktu.toDate().toLocaleString("id-ID"):"-"}</div>
      <b>Nama:</b> ${d.nama}<br>
      <b>Unit:</b> ${d.unit}<br><br>
      <b>Kendala:</b><br>${d.kendala}<br>

      <label>Status</label>
      <select id="status-${d.id}">
        <option ${d.status==="baru"?"selected":""}>baru</option>
        <option ${d.status==="proses"?"selected":""}>proses</option>
        <option ${d.status==="pending"?"selected":""}>pending</option>
        <option ${d.status==="selesai"?"selected":""}>selesai</option>
      </select>

      <label>Respon Teknisi</label>
      <textarea id="respon-${d.id}">${d.respon||""}</textarea>

      <button onclick="simpan('${d.id}')">üíæ Simpan</button>
    `;
    daftar.appendChild(card);
  });
}

function simpan(id){
  db.collection("laporan").doc(id).update({
    status:document.getElementById(`status-${id}`).value,
    respon:document.getElementById(`respon-${id}`).value
  }).then(()=>showToast("Data tersimpan ‚úÖ"));
}

function exportExcel(){
  const data=allData.map(d=>({
    Nama:d.nama,
    Unit:d.unit,
    Kendala:d.kendala,
    Status:d.status,
    Respon:d.respon,
    Waktu:d.waktu?d.waktu.toDate().toLocaleString("id-ID"):""
  }));
  const ws=XLSX.utils.json_to_sheet(data);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Laporan IPSRS");
  XLSX.writeFile(wb,"laporan_ipsrs.xlsx");
}

searchInput.addEventListener("input",renderData);
dateInput.addEventListener("change",renderData);
</script>

</body>
</html>
